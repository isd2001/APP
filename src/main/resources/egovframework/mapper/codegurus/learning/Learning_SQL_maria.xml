<?xml version="1.0" encoding="UTF-8"?><!--Converted at: Wed May 11 15:49:38 KST 2016-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="codegurus.learning.LearningDAO">

	<!-- 오늘의 학습 책 상세 조회 -->
	<resultMap id="BookDetailMap" type="BookVO" autoMapping="true">
		<!--<id property="contentsId" column="contents_id"/>
		<association property="book" javaType="BookVO" autoMapping="true">-->
			<id property="bookId" column="book_id"/>
			<result property="bookThumbnailFileId" column="book_thumbnail_file_id"/>
			<association property="bookThumbnail" javaType="FileVO" autoMapping="true">
				<id property="atchFileId" column="book_thumbnail_file_id"/>
			</association>
			<collection property="labelList" ofType="LabelVO" autoMapping="true" />
		<!--</association>-->
	</resultMap>
	<select id="selectBookDetail" resultMap="BookDetailMap">
		SELECT /* selectBookDetail */
		    schedule.online_subject_schedule_id,
		    contents.contents_id,
		    contents.book_id,

		    book.book_thumbnail_file_id,

			labelManage.label_manage_id,
			labelManage.label_title,

			COMTNFILE.ATCH_FILE_ID,
			COMTNFILEDETAIL.FILE_CN,
			COMTNFILEDETAIL.FILE_SN,
			COMTNFILEDETAIL.FILE_STRE_COURS,
			COMTNFILEDETAIL.STRE_FILE_NM,
			COMTNFILEDETAIL.FILE_EXTSN,
			COMTNFILEDETAIL.ORIGNL_FILE_NM,
			COMTNFILEDETAIL.FILE_SIZE,
			COMTNFILE.CREAT_DT,
			COMTNFILEDETAIL.DOWNLOAD_CNT
		FROM online_subject_schedule schedule
		LEFT JOIN contents contents
			on schedule.contents_id = contents.contents_id
		LEFT JOIN book book
			on contents.book_id = book.book_id
		LEFT JOIN label_mapping labelMapping
		  	on 	labelMapping.label_domain_manage_id = 1 /* 1:책 */
			and labelMapping.object_manage_id = book.book_id
			and labelMapping.delete_ornot = 'N'
		LEFT JOIN label_manage labelManage
			on 	labelManage.label_manage_id = labelMapping.label_manage_id
			and labelManage.label_domain_manage_id = labelMapping.label_domain_manage_id
			and labelManage.delete_ornot = 'N'
		LEFT JOIN COMTNFILE
			on book.book_thumbnail_file_id = COMTNFILE.ATCH_FILE_ID
		LEFT JOIN COMTNFILEDETAIL
			on book.book_thumbnail_file_id = COMTNFILEDETAIL.ATCH_FILE_ID
		WHERE 1=1
		  AND schedule.online_subject_schedule_id = #{onlineSubjectScheduleId}
	</select>

	<!-- 학습 콘텐츠 조회 -->
	<resultMap id="ContentsMap" type="ContentsVO" autoMapping="true">
		<id property="contentsId" column="contents_id"/>
		<collection property="templateInstList" ofType="TemplateInstVO" autoMapping="true">
			<id property="templateInstId" column="template_inst_id"/>
			<result property="contentsId" column="contents_id"/>
			<result property="templateId" column="template_id"/>
			<result property="cateId" column="template_inst_cate_id"/>
			<result property="order" column="template_inst_order"/>
			<association property="cate" javaType="CateVO" autoMapping="true">
				<result property="cateId" column="template_inst_cate_cate_id"/>
				<result property="parentsId" column="template_inst_cate_parents_id"/>
				<result property="depth" column="template_inst_cate_depth"/>
				<result property="order" column="template_inst_cate_order"/>
				<result property="cateTitle" column="template_inst_cate_cate_title"/>
				<result property="firstCateTitle" column="template_inst_cate_first_cate_title"/>
				<result property="secondCateTitle" column="template_inst_cate_second_cate_title"/>
				<result property="thirdCateTitle" column="template_inst_cate_third_cate_title"/>
				<result property="fourthCateTitle" column="template_inst_cate_fourth_cate_title"/>
				<result property="fifthCateTitle" column="template_inst_cate_fifth_cate_title"/>
				<result property="sixthCateTitle" column="template_inst_cate_sixth_cate_title"/>
				<result property="seventhCateTitle" column="template_inst_cate_seventh_cate_title"/>
				<result property="eightCateTitle" column="template_inst_cate_eight_cate_title"/>
				<result property="ninthCateTitle" column="template_inst_cate_ninth_cate_title"/>
				<result property="tenthCateTitle" column="template_inst_cate_tenth_cate_title"/>
				<result property="firstCateId" column="template_inst_cate_first_cate_id"/>
				<result property="secondCateId" column="template_inst_cate_second_cate_id"/>
				<result property="thirdCateId" column="template_inst_cate_third_cate_id"/>
				<result property="fourthCateId" column="template_inst_cate_fourth_cate_id"/>
				<result property="fifthCateId" column="template_inst_cate_fifth_cate_id"/>
				<result property="sixthCateId" column="template_inst_cate_sixth_cate_id"/>
				<result property="seventhCateId" column="template_inst_cate_seventh_cate_id"/>
				<result property="eightCateId" column="template_inst_cate_eight_cate_id"/>
				<result property="ninthCateId" column="template_inst_cate_ninth_cate_id"/>
				<result property="tenthCateId" column="template_inst_cate_tenth_cate_id"/>
			</association>
		</collection>
	</resultMap>
	<select id="selectLearningContents" resultMap="ContentsMap">
		SELECT /* selectContents */
			schedule.online_subject_schedule_id,

			template_inst.contents_id,
		    template_inst.template_inst_id,
		    template_inst.template_id,
		    template_inst.json,
		    template_inst.`order` as template_inst_order,
		    template_inst.type,
		    template_inst.difficulty,
		    template_inst.cate_id as template_inst_cate_id,

			template_inst_cate.cate_id as template_inst_cate_cate_id,
			template_inst_cate.parents_id as template_inst_cate_parents_id,
			template_inst_cate.depth as template_inst_cate_depth,
			template_inst_cate.`order` as template_inst_cate_order,
			template_inst_cate.cate_title as template_inst_cate_cate_title,
			template_inst_cate.first_cate_title as template_inst_cate_first_cate_title,
			template_inst_cate.second_cate_title as template_inst_cate_second_cate_title,
			template_inst_cate.third_cate_title as template_inst_cate_third_cate_title,
			template_inst_cate.fourth_cate_title as template_inst_cate_fourth_cate_title,
			template_inst_cate.fifth_cate_title as template_inst_cate_fifth_cate_title,
			template_inst_cate.sixth_cate_title as template_inst_cate_sixth_cate_title,
			template_inst_cate.seventh_cate_title as template_inst_cate_seventh_cate_title,
			template_inst_cate.eight_cate_title as template_inst_cate_eight_cate_title,
			template_inst_cate.ninth_cate_title as template_inst_cate_ninth_cate_title,
			template_inst_cate.tenth_cate_title as template_inst_cate_tenth_cate_title,
			template_inst_cate.first_cate_id as template_inst_cate_first_cate_id,
			template_inst_cate.second_cate_id as template_inst_cate_second_cate_id,
			template_inst_cate.third_cate_id as template_inst_cate_third_cate_id,
			template_inst_cate.fourth_cate_id as template_inst_cate_fourth_cate_id,
			template_inst_cate.fifth_cate_id as template_inst_cate_fifth_cate_id,
			template_inst_cate.sixth_cate_id as template_inst_cate_sixth_cate_id,
			template_inst_cate.seventh_cate_id as template_inst_cate_seventh_cate_id,
			template_inst_cate.eight_cate_id as template_inst_cate_eight_cate_id,
			template_inst_cate.ninth_cate_id as template_inst_cate_ninth_cate_id,
			template_inst_cate.tenth_cate_id as template_inst_cate_tenth_cate_id

		FROM online_subject_schedule schedule
		LEFT JOIN contents
			on schedule.contents_id = contents.contents_id
		LEFT JOIN template_inst
			on contents.contents_id = template_inst.contents_id
		LEFT JOIN cate as template_inst_cate
			on template_inst.cate_id = template_inst_cate.cate_id
		WHERE
			1=1
		AND contents.contents_id = #{contentsId}
	</select>

	<!-- 학습 콘텐츠 이력 등록 -->
	<insert id="insertLearningContentsHistory" useGeneratedKeys="true" keyProperty="contentsHistoryId">
		INSERT /* insertLearningContentsHistory */
		INTO contents_history
		(
			online_subject_schedule_id,
		 	summary_doing_drawing_file_id,
			summary_doing_vice_file_id,
		 	reg_id,
		 	reg_date,
		 	delete_ornot
		)
		VALUES
		(
			#{contentsTitle},
			#{summaryDoingDrawingFileId},
			#{summaryDoingVoiceFileId},
			#{regId},
			CURRENT_TIMESTAMP,
			'N'
		)
	</insert>

	<!-- 학습 콘텐츠 템플릿 인스턴스 이력 등록 -->
	<insert id="insertTemplateInstHistory" useGeneratedKeys="true" keyProperty="templateInstHistoryId" parameterType="java.util.List">
		INSERT /* insertTemplateInstHistory */
		INTO template_inst_history
		(
			contents_history_id,
			template_inst_id,
		 	correctanswer_status,
		 	reg_id,
		 	reg_date,
		 	delete_ornot
		)
		VALUES
		<foreach collection="list" item="item" index="index" separator=",">
			(

			#{item.contentsHistoryId},
			#{item.templateInstId},
			#{item.correctanswerStatus},
			#{item.regId},
			CURRENT_TIMESTAMP,
			'N'
			)
		</foreach>
	</insert>
</mapper>