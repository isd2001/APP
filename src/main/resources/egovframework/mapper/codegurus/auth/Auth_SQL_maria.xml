<?xml version="1.0" encoding="UTF-8"?><!--Converted at: Wed May 11 15:49:38 KST 2016-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="codegurus.auth.AuthDAO">

    <!-- 사용자 중복 체크 (회원가입 화면) -->
    <select id="selectUserDup" resultType="int">
        select /* selectUserDup */
            count(*)
        from user_manage um
        where user_id = #{username}
        and DELETE_ORNOT = 'N'
    </select>

    <!-- 사용자 등록 (회원가입) -->
    <insert id="insertRegisterInfo" useGeneratedKeys="true" keyProperty="userManageId">
        INSERT /* insertRegisterInfo */
        INTO user_manage
        (
            user_id,
            password,
            password_mask,
            name,
            birth,
            gender,
            <!-- 이후에 필요할 지 몰라 백업
            cellphone,
            email,
            zipcode,
            address,
            address_detail,
            -->
            termofuse_agree_ornot,
            personalinfo_agree_ornot,
            promotion_agree_ornot,
            <!-- locationinfo_agree_ornot, --><!-- 필요하면 사용  -->
            termofuse_agree_date,
            personalinfo_agree_date,
            promotion_agree_date,
            <!-- locationinfo_agree_date, -->
            reg_id,
            reg_date,
            modify_id,
            modify_date
        )
        values
        (
           #{username},
           #{password},
           #{passwordMask},
           #{name},
           #{birth},
           #{gender},
           <!-- 이후에 필요할 지 몰라 백업
           #{cellphone},
           #{email},
           #{zipcode},
           #{address},
           #{addressDetail},
           -->
           #{termofuseAgreeOrnot},
           #{personalinfoAgreeOrnot},
           #{promotionAgreeOrnot},
           <!-- #{locationinfoAgreeOrnot}, -->
           <choose>
               <when test='termofuseAgreeOrnot != null and termofuseAgreeOrnot != "" and termofuseAgreeOrnot == "Y"'>CURRENT_TIMESTAMP,</when>
               <otherwise>null,</otherwise>
           </choose>
           <choose>
               <when test='personalinfoAgreeOrnot != null and personalinfoAgreeOrnot != "" and personalinfoAgreeOrnot == "Y"'>CURRENT_TIMESTAMP,</when>
               <otherwise>null,</otherwise>
           </choose>
           <choose>
               <when test='promotionAgreeOrnot != null and promotionAgreeOrnot != "" and promotionAgreeOrnot == "Y"'>CURRENT_TIMESTAMP,</when>
               <otherwise>null,</otherwise>
           </choose>
           <!--
           <choose>
               <when test='locationinfoAgreeOrnot != null and locationinfoAgreeOrnot != "" and locationinfoAgreeOrnot == "Y"'>CURRENT_TIMESTAMP,</when>
               <otherwise>null,</otherwise>
           </choose>
           -->
           0, /* reg_id (아직 user_manage_id 가 없는 상태이기 때문에) */
           CURRENT_TIMESTAMP,
           0,
           CURRENT_TIMESTAMP
        )
    </insert>

    <!-- 사용자 권한 매핑 등록 -->
    <insert id="insertUserAuth" useGeneratedKeys="true" keyProperty="userAuthId">
        INSERT /* insertUserAuth */
        INTO user_auth
        (
            user_manage_id,
            auth_id
        )
        VALUES
        (
            #{userManageId},
            #{authId}
        )
    </insert>

    <!-- 체험회원 등록 -->
    <insert id="insertTrialRegister" useGeneratedKeys="true" keyProperty="trialManageId">
        INSERT /* insertTrialRegister */
        INTO trial_manage
        (
            name,
            birth,
            gender,
            parents_name,
            parents_birth,
            parents_cellphone,
            trial_start_date,
            trial_end_date
        )
        VALUES
        (
            #{name},
            #{birth},
            #{gender},
            #{parentName},
            #{parentBirth},
            #{parentCellphone},
            CURRENT_TIMESTAMP,
            DATE_ADD(CURRENT_TIMESTAMP(), INTERVAL #{trialPeriod} DAY)
        )
    </insert>

    <!-- 체험회원 정보 조회 -->
    <select id="selectTrialUser" resultType="ResTrialUserVO">
        SELECT /* selectTrialUser */
            trial_manage_id,
            name,
            birth,
            gender,
            parents_name as parentName,
            parents_birth as parentBirth,
            parents_cellphone as parentCellphone,
            DF8(trial_start_date) as trial_start_date,
            DF8(trial_end_date) as trial_end_date,
            trial_status_code,
            reg_date,
            delete_ornot,
            if(DF8(NOW()) <![CDATA[ <= ]]> DF8(trial_end_date), 'Y', 'N') as validPeriod
        FROM
            trial_manage tm
        WHERE trial_manage_id = #{value}
          AND trial_status_code = '00'
          AND delete_ornot = 'N'
    </select>


    <!-- SMS 인증 insert -->
    <insert id="insertSmsCert" useGeneratedKeys="true" keyProperty="smsCertId">
        INSERT /* insertSmsCert */
        INTO sms_cert
        (
            sms_type,
            name,
            cellphone,
            cert_number
        )
        values
        (
            #{smsType},
            #{name},
            #{cellphone},
            #{certNumber}
        )
    </insert>

    <!-- SMS 인증 조회 -->
    <select id="selectSmsCert" resultType="LHMap">
        SELECT /* selectSmsCert */
            sms_cert_id,
            sms_type,
            name,
            cellphone,
            cert_number,
            cert_req_date
        FROM
            sms_cert
        WHERE sms_cert_id = #{smsCertId}
    </select>

    <!-- SMS 인증 update -->
    <update id="updateSmsCert">
        UPDATE /* updateSmsCert */
            sms_cert
        SET
            cert_success_date = CURRENT_TIMESTAMP
        WHERE sms_cert_id = #{smsCertId}
    </update>


</mapper>